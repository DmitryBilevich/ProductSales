<div class="products-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="page-title-section">
      <h1 class="page-title">
        <i class="pi pi-box mr-3"></i>
        Product Management
      </h1>
      <p class="page-subtitle">Manage your gift shop inventory</p>
    </div>
    
    <div class="page-actions">
      <!-- Actions will be moved to individual view modes -->
    </div>
  </div>

  <!-- View Switcher -->
  <Card class="view-switcher-card">
    <template #content>
      <div class="view-switcher">
        <div class="view-options">
          <h3 class="view-title">View Mode</h3>
          <SelectButton 
            v-model="selectedView" 
            :options="viewOptions" 
            optionLabel="label"
            optionValue="value"
            @change="onViewChange"
          >
            <template #option="slotProps">
              <i :class="slotProps.option.icon" class="mr-2"></i>
              <span>{{ slotProps.option.label }}</span>
            </template>
          </SelectButton>
        </div>
        
        <div class="display-options">
          <div class="field-checkbox">
            <Checkbox v-model="showAdvancedFilters" :binary="true" inputId="advanced" />
            <label for="advanced" class="ml-2">Advanced Filters</label>
          </div>
        </div>
      </div>
    </template>
  </Card>

  <!-- Advanced Filters Panel -->
  <Card v-if="showAdvancedFilters" class="filters-card">
    <template #title>
      <div class="flex align-items-center">
        <i class="pi pi-filter mr-2"></i>
        <span>Advanced Filters</span>
      </div>
    </template>
    
    <template #content>
      <div class="filter-grid">
        <!-- Row 1: Text Filters -->
        <div class="filter-row">
          <div class="filter-group">
            <label for="name-filter">Product Name</label>
            <InputText 
              id="name-filter"
              v-model="filters.name" 
              placeholder="🔍 Search by name..."
              @keyup.enter="search"
            />
          </div>
          
          <div class="filter-group">
            <label for="category-filter">Categories</label>
            <MultiSelect
              id="category-filter"
              v-model="filters.categories"
              :options="categoryOptions"
              placeholder="All Categories"
              display="chip"
              class="w-full"
              @change="search"
            />
          </div>
          
          <div class="filter-group">
            <label for="sku-filter">SKU</label>
            <InputText 
              id="sku-filter"
              v-model="filters.sku" 
              placeholder="📦 Search by SKU..."
              @keyup.enter="search"
            />
          </div>
        </div>

        <!-- Row 2: Range Filters -->
        <div class="filter-row">
          <div class="filter-group">
            <label>Price Range</label>
            <div class="price-range">
              <InputNumber
                v-model="filters.priceMin"
                placeholder="Min"
                :min="0"
                :maxFractionDigits="2"
                class="price-input"
                @change="search"
              />
              <span class="range-separator">to</span>
              <InputNumber
                v-model="filters.priceMax"
                placeholder="Max"
                :min="0"
                :maxFractionDigits="2"
                class="price-input"
                @change="search"
              />
            </div>
          </div>
          
          <div class="filter-group">
            <label>Stock Range</label>
            <div class="stock-range">
              <InputNumber
                v-model="filters.stockMin"
                placeholder="Min"
                :min="0"
                class="stock-input"
                @change="search"
              />
              <span class="range-separator">to</span>
              <InputNumber
                v-model="filters.stockMax"
                placeholder="Max"
                :min="0"
                class="stock-input"
                @change="search"
              />
            </div>
          </div>
          
          <div class="filter-group">
            <label>
              Stock Status 
              <small class="inline-help-text">(Out: 0, Low: 1-10, In: 11+)</small>
            </label>
            <MultiSelect
              v-model="filters.stockStatus"
              :options="stockStatusOptions"
              optionLabel="label"
              optionValue="value"
              placeholder="All Status"
              display="chip"
              class="w-full"
              @change="search"
            />
          </div>
        </div>

        <!-- Row 3: Sale Start Date Filter -->
        <div class="filter-row">
          <div class="filter-group">
            <label>Sale Start Date Range</label>
            <div class="date-range">
              <Calendar
                v-model="filters.saleStartDateMin"
                placeholder="Start Date"
                dateFormat="mm/dd/yy"
                showIcon
                class="date-input"
                @date-select="search"
                @clear-click="search"
              />
              <span class="range-separator">to</span>
              <Calendar
                v-model="filters.saleStartDateMax"
                placeholder="End Date"
                dateFormat="mm/dd/yy"
                showIcon
                class="date-input"
                @date-select="search"
                @clear-click="search"
              />
            </div>
          </div>
        </div>

        <!-- Filter Actions -->
        <div class="filter-actions">
          <Button
            label="Search"
            icon="pi pi-search"
            @click="search"
            class="p-button-primary"
          />
          <Button
            label="Clear All"
            icon="pi pi-times"
            @click="clearFilters"
            class="p-button-outlined"
          />
          <Button
            label="Save Filters"
            icon="pi pi-save"
            @click="saveFilters"
            class="p-button-outlined p-button-secondary"
          />
        </div>
      </div>
    </template>
  </Card>

  <!-- Quick Filters (when advanced is hidden) -->
  <Card v-else class="quick-filters-card">
    <template #content>
      <div class="quick-filters">
        <InputText 
          v-model="quickSearchText" 
          placeholder="🔍 Quick search by name or SKU..."
          @keyup.enter="search"
          @input="onQuickSearchInput"
          class="quick-search"
        />
        
        <MultiSelect
          v-model="filters.categories"
          :options="categoryOptions"
          placeholder="Categories"
          display="chip"
          @change="search"
        />
        
        <Button
          label="Search"
          icon="pi pi-search"
          @click="search"
          class="p-button-primary"
        />
        <Button
          label="Reset"
          icon="pi pi-refresh"
          @click="clearFilters"
          class="p-button-outlined"
        />
      </div>
    </template>
  </Card>

  <!-- Tree View -->
  <div v-if="currentView === 'tree'" class="tree-view-container">
    <div class="tree-layout">
      <!-- Left Side: Category Tree -->
      <Card class="tree-panel">
        <template #title>
          <div class="tree-header">
            <i class="pi pi-sitemap mr-2"></i>
            <span>Product Categories</span>
          </div>
        </template>
        
        <template #content>
          <div class="tree-controls mb-3">
            <Button
              label="Expand All"
              icon="pi pi-plus"
              @click="expandAll"
              class="p-button-text p-button-sm mr-2"
            />
            <Button
              label="Collapse All"
              icon="pi pi-minus"
              @click="collapseAll"
              class="p-button-text p-button-sm"
            />
          </div>
          
          <Tree
            :value="treeNodes"
            :expandedKeys="expandedKeys"
            :selectionKeys="selectedKeys"
            selectionMode="single"
            @node-select="onNodeSelect"
            @node-unselect="onNodeUnselect"
            @node-expand="onNodeExpand"
            @node-collapse="onNodeCollapse"
            class="category-tree"
          >
            <template #default="slotProps">
              <div class="tree-node-content">
                <span class="node-label">{{ slotProps.node.label }}</span>
                <Tag 
                  v-if="slotProps.node.count !== undefined" 
                  :value="slotProps.node.count" 
                  class="node-count"
                  severity="info"
                />
              </div>
            </template>
          </Tree>
        </template>
      </Card>
      
      <!-- Right Side: Product Form/Details -->
      <Card class="form-panel">
        <template #title>
          <div class="form-header">
            <i class="pi pi-box mr-2"></i>
            <span v-if="selectedProduct">{{ selectedProduct.name || 'Edit Product' }}</span>
            <span v-else-if="selectedCategory">Products in {{ selectedCategory }}</span>
            <span v-else>Select a category or product</span>
          </div>
        </template>
        
        <template #content>
          <!-- Product Form (when editing) -->
          <div v-if="selectedProduct" class="tree-product-form">
            <div class="form-actions mb-4">
              <Button
                label="Save Changes"
                icon="pi pi-save"
                @click="saveTreeProduct"
                class="p-button-success mr-2"
                :loading="saving"
              />
              <Button
                label="Cancel"
                icon="pi pi-times"
                @click="cancelTreeEdit"
                class="p-button-outlined"
              />
              <Button
                label="Delete"
                icon="pi pi-trash"
                @click="confirmDelete(selectedProduct)"
                class="p-button-danger p-button-outlined ml-auto"
              />
            </div>
            
            <!-- Product Form Fields -->
            <div class="tree-form-grid">
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">SKU</label>
                  <InputText v-model="treeForm.sku" disabled class="form-input" />
                </div>
                <div class="form-group">
                  <label class="form-label">Category</label>
                  <Dropdown
                    v-model="treeForm.category"
                    :options="categoryOptions"
                    placeholder="Select category"
                    class="form-input"
                    showClear
                    editable
                  />
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group full-width">
                  <label class="form-label">Product Name</label>
                  <InputText v-model="treeForm.name" placeholder="Enter product name" class="form-input" />
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Price</label>
                  <InputNumber
                    v-model="treeForm.price"
                    :min="0"
                    :maxFractionDigits="2"
                    mode="currency"
                    currency="USD"
                    class="form-input"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label">Stock</label>
                  <InputNumber
                    v-model="treeForm.quantityInStock"
                    :min="0"
                    class="form-input"
                  />
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Sale Start Date</label>
                  <Calendar
                    v-model="treeForm.saleStartDate"
                    placeholder="Select sale start date"
                    dateFormat="mm/dd/yy"
                    showIcon
                    class="form-input"
                  />
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group full-width">
                  <label class="form-label">Description</label>
                  <Textarea
                    v-model="treeForm.description"
                    placeholder="Enter product description..."
                    :rows="4"
                    class="form-input"
                  />
                </div>
              </div>
              
              <!-- Image Management -->
              <div class="form-row">
                <div class="form-group full-width">
                  <label class="form-label">Product Images</label>
                  <div class="tree-image-management">
                    <div v-if="treeForm.images?.length" class="image-gallery-tree">
                      <div
                        v-for="(image, index) in treeForm.images"
                        :key="image.imageID"
                        class="image-item-tree"
                      >
                        <img :src="image.imageUrl" :alt="`Image ${index + 1}`" class="tree-thumbnail" />
                        <div class="image-controls-tree">
                          <Button
                            icon="pi pi-arrow-up"
                            class="p-button-text p-button-sm"
                            @click="moveTreeImageUp(index)"
                            :disabled="index === 0"
                            title="Move Up"
                          />
                          <Button
                            icon="pi pi-arrow-down"
                            class="p-button-text p-button-sm"
                            @click="moveTreeImageDown(index)"
                            :disabled="index === treeForm.images.length - 1"
                            title="Move Down"
                          />
                          <Button
                            icon="pi pi-times"
                            class="p-button-text p-button-sm p-button-danger"
                            @click="removeTreeImage(index)"
                            title="Remove"
                          />
                        </div>
                      </div>
                    </div>
                    
                    <div class="add-image-tree">
                      <input
                        type="file"
                        accept="image/*"
                        @change="addTreeImage"
                        style="display: none"
                        id="treeFileInput"
                      />
                      <Button
                        label="Add Image"
                        icon="pi pi-plus"
                        @click="openTreeFileDialog"
                        class="p-button-outlined"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Category Products List (when category selected) -->
          <div v-else-if="selectedCategory && categoryProducts.length" class="category-products">
            <div class="category-actions mb-4">
              <Button
                label="Add New Product"
                icon="pi pi-plus"
                @click="addProductToCategory"
                class="p-button-success"
              />
            </div>
            
            <DataTable
              :value="categoryProducts"
              responsiveLayout="scroll"
              class="category-products-table"
            >
              <Column header="Image" style="width: 80px">
                <template #body="slotProps">
                  <div class="mini-image-cell">
                    <img
                      v-if="slotProps.data.images?.length"
                      :src="slotProps.data.images[0].imageUrl"
                      :alt="slotProps.data.name"
                      class="mini-image"
                    />
                    <div v-else class="no-image-mini">
                      <i class="pi pi-image"></i>
                    </div>
                  </div>
                </template>
              </Column>
              
              <Column field="Name" header="Name" sortable>
                <template #body="slotProps">
                  <div class="clickable-name" @click="selectProduct(slotProps.data)">
                    <span class="product-name-link">{{ slotProps.data.name }}</span>
                    <small v-if="slotProps.data.description" class="product-desc-mini">
                      {{ slotProps.data.description.substring(0, 50) }}...
                    </small>
                  </div>
                </template>
              </Column>
              
              <Column field="Price" header="Price" sortable>
                <template #body="slotProps">
                  <span class="price-text">${{ Number(slotProps.data.price).toFixed(2) }}</span>
                </template>
              </Column>
              
              <Column field="Stock" header="Stock" sortable>
                <template #body="slotProps">
                  <Tag
                    :value="slotProps.data.quantityInStock"
                    :severity="getStockSeverity(slotProps.data.quantityInStock)"
                  />
                </template>
              </Column>
            </DataTable>
          </div>
          
          <!-- Empty State -->
          <div v-else class="empty-state">
            <div class="empty-content">
              <i class="pi pi-box empty-icon"></i>
              <h3>No Selection</h3>
              <p v-if="!selectedCategory">Select a category from the tree to view products, or click on a specific product to edit it.</p>
              <p v-else>This category has no products yet.</p>
              <Button
                v-if="selectedCategory"
                label="Add First Product"
                icon="pi pi-plus"
                @click="addProductToCategory"
                class="p-button-success mt-3"
              />
            </div>
          </div>
        </template>
      </Card>
    </div>
  </div>

  <!-- Import View -->
  <div v-if="currentView === 'import'" class="import-view-container">
    <div class="import-layout">
      <!-- Import Summary Card -->
      <Card class="import-summary-card">
        <template #title>
          <div class="import-header">
            <i class="pi pi-upload mr-2"></i>
            <span>Bulk Product Import</span>
          </div>
        </template>
        
        <template #content>
          <!-- File Upload Section -->
          <div v-if="!importSessionId" class="upload-section">
            <div class="upload-instructions">
              <h3>Import Products from File</h3>
              <p>Upload an Excel (.xlsx, .xls) or CSV file to bulk import/update products.</p>
              
              <div class="upload-steps">
                <div class="step">
                  <i class="pi pi-download step-icon"></i>
                  <span>1. Download template file</span>
                  <Button 
                    label="Download Template" 
                    icon="pi pi-download" 
                    @click="downloadTemplate"
                    class="p-button-outlined p-button-sm ml-2"
                  />
                </div>
                <div class="step">
                  <i class="pi pi-file-edit step-icon"></i>
                  <span>2. Fill in your product data</span>
                </div>
                <div class="step">
                  <i class="pi pi-upload step-icon"></i>
                  <span>3. Upload the completed file</span>
                </div>
              </div>
            </div>
            
            <div class="file-upload-zone">
              <input 
                type="file" 
                ref="fileInput"
                accept=".xlsx,.xls,.csv" 
                @change="handleFileUpload"
                style="display: none"
              />
              <Button 
                label="Choose File" 
                icon="pi pi-upload" 
                @click="$refs.fileInput.click()"
                class="p-button-success p-button-lg"
                :loading="uploadProgress.uploading"
              />
              <p class="upload-note">Maximum file size: 5MB</p>
              <p v-if="uploadProgress.message" class="upload-message">{{ uploadProgress.message }}</p>
            </div>
          </div>
          
          <!-- Import Summary -->
          <div v-else class="import-summary">
            <div class="summary-stats">
              <div class="stat-item">
                <div class="stat-value">{{ importData.summary.totalRows }}</div>
                <div class="stat-label">Total Rows</div>
              </div>
              <div class="stat-item success">
                <div class="stat-value">{{ importData.summary.newProducts }}</div>
                <div class="stat-label">New Products</div>
              </div>
              <div class="stat-item info">
                <div class="stat-value">{{ importData.summary.updatedProducts }}</div>
                <div class="stat-label">Updates</div>
              </div>
              <div class="stat-item" :class="{ 'error': importData.summary.errorRows > 0 }">
                <div class="stat-value">{{ importData.summary.errorRows }}</div>
                <div class="stat-label">Errors</div>
              </div>
            </div>
            
            <div class="import-actions">
              <Button 
                label="Process Import" 
                icon="pi pi-check" 
                @click="processImport"
                class="p-button-success"
                :disabled="importData.summary.errorRows > 0 || importData.processing"
                :loading="importData.processing"
              />
              <Button 
                label="Clear Import" 
                icon="pi pi-times" 
                @click="clearImport"
                class="p-button-danger p-button-outlined ml-2"
              />
              <Button 
                label="Upload New File" 
                icon="pi pi-upload" 
                @click="importSessionId = null"
                class="p-button-outlined ml-2"
              />
            </div>
          </div>
        </template>
      </Card>
      
      <!-- Import Data Table -->
      <Card v-if="importSessionId" class="import-data-card">
        <template #title>
          <div class="table-header">
            <div class="table-info">
              <span class="table-title">Import Preview</span>
              <Tag v-if="importData.totalCount" :value="`${importData.totalCount} items`" class="ml-2" />
            </div>
          </div>
        </template>
        
        <template #content>
          <DataTable
            :value="importData.items"
            :lazy="true"
            :paginator="true"
            :rows="importData.pageSize"
            :totalRecords="importData.totalCount"
            :first="(importData.pageNumber - 1) * importData.pageSize"
            :loading="importData.loading"
            @page="onImportPage"
            responsiveLayout="scroll"
            :sortField="importData.sortField"
            :sortOrder="importData.sortOrder"
            @sort="onImportSort"
            stripedRows
            class="import-table"
            :rowClass="getImportRowClass"
            paginatorTemplate="FirstPageLink PrevPageLink PageLinks NextPageLink LastPageLink CurrentPageReport RowsPerPageDropdown"
            currentPageReportTemplate="Showing {first} to {last} of {totalRecords} items"
          >
            <Column field="rowNumber" header="Row" sortable style="width: 80px">
              <template #body="slotProps">
                <span class="row-number">{{ slotProps.data.rowNumber }}</span>
              </template>
            </Column>
            
            <Column field="operationType" header="Operation" sortable style="width: 100px">
              <template #body="slotProps">
                <Tag 
                  :value="slotProps.data.operationType" 
                  :severity="getImportOperationSeverity(slotProps.data.operationType)"
                />
              </template>
            </Column>
            
            <Column field="sku" header="SKU" sortable style="min-width: 120px">
              <template #body="slotProps">
                <div v-if="isImportItemEditing(slotProps.data.stagingID)" class="inline-edit-cell">
                  <InputText
                    v-model="editingImportItems[slotProps.data.stagingID].sku"
                    placeholder="SKU"
                    class="inline-input"
                    :disabled="editingImportItems[slotProps.data.stagingID]?.saving"
                  />
                </div>
                <div v-else>
                  <span class="sku-text">{{ slotProps.data.sku || 'Not set' }}</span>
                </div>
              </template>
            </Column>
            
            <Column field="name" header="Name" sortable style="min-width: 200px">
              <template #body="slotProps">
                <div v-if="isImportItemEditing(slotProps.data.stagingID)" class="inline-edit-cell">
                  <InputText
                    v-model="editingImportItems[slotProps.data.stagingID].name"
                    placeholder="Product name"
                    class="inline-input"
                    :disabled="editingImportItems[slotProps.data.stagingID]?.saving"
                  />
                </div>
                <div v-else class="name-cell">
                  <span class="product-name">{{ slotProps.data.name }}</span>
                  <div v-if="slotProps.data.operationType === 'Update' && slotProps.data.currentName !== slotProps.data.name" class="change-indicator">
                    <small class="current-value">Current: {{ slotProps.data.currentName }}</small>
                  </div>
                </div>
              </template>
            </Column>
            
            <Column field="category" header="Category" sortable style="min-width: 120px">
              <template #body="slotProps">
                <div v-if="isImportItemEditing(slotProps.data.stagingID)" class="inline-edit-cell">
                  <Dropdown
                    v-model="editingImportItems[slotProps.data.stagingID].category"
                    :options="categoryOptions"
                    placeholder="Select category"
                    class="inline-input"
                    showClear
                    editable
                    :disabled="editingImportItems[slotProps.data.stagingID]?.saving"
                  />
                </div>
                <div v-else>
                  <Tag :value="slotProps.data.category || 'Not set'" class="category-tag" />
                  <div v-if="slotProps.data.operationType === 'Update' && slotProps.data.currentCategory !== slotProps.data.category" class="change-indicator">
                    <small class="current-value">Current: {{ slotProps.data.currentCategory }}</small>
                  </div>
                </div>
              </template>
            </Column>
            
            <Column field="price" header="Price" sortable style="min-width: 100px">
              <template #body="slotProps">
                <div v-if="isImportItemEditing(slotProps.data.stagingID)" class="inline-edit-cell">
                  <InputNumber
                    v-model="editingImportItems[slotProps.data.stagingID].price"
                    :min="0"
                    :maxFractionDigits="2"
                    mode="currency"
                    currency="USD"
                    class="inline-input"
                    :disabled="editingImportItems[slotProps.data.stagingID]?.saving"
                  />
                </div>
                <div v-else>
                  <span class="price-text">${{ Number(slotProps.data.price).toFixed(2) }}</span>
                  <div v-if="slotProps.data.operationType === 'Update' && slotProps.data.currentPrice !== slotProps.data.price" class="change-indicator">
                    <small class="current-value">Current: ${{ Number(slotProps.data.currentPrice).toFixed(2) }}</small>
                  </div>
                </div>
              </template>
            </Column>
            
            <Column field="quantityInStock" header="Stock" sortable style="min-width: 100px">
              <template #body="slotProps">
                <div v-if="isImportItemEditing(slotProps.data.stagingID)" class="inline-edit-cell">
                  <InputNumber
                    v-model="editingImportItems[slotProps.data.stagingID].quantityInStock"
                    :min="0"
                    class="inline-input"
                    :disabled="editingImportItems[slotProps.data.stagingID]?.saving"
                  />
                </div>
                <div v-else>
                  <Tag 
                    :value="slotProps.data.quantityInStock" 
                    :severity="getStockSeverity(slotProps.data.quantityInStock)"
                  />
                  <div v-if="slotProps.data.operationType === 'Update' && slotProps.data.currentQuantityInStock !== slotProps.data.quantityInStock" class="change-indicator">
                    <small class="current-value">Current: {{ slotProps.data.currentQuantityInStock }}</small>
                  </div>
                </div>
              </template>
            </Column>
            
            <Column field="saleStartDate" header="Sale Start Date" sortable style="min-width: 120px">
              <template #body="slotProps">
                <div v-if="isImportItemEditing(slotProps.data.stagingID)" class="inline-edit-cell">
                  <Calendar
                    v-model="editingImportItems[slotProps.data.stagingID].saleStartDate"
                    placeholder="Select date"
                    dateFormat="mm/dd/yy"
                    showIcon
                    class="inline-input"
                    :disabled="editingImportItems[slotProps.data.stagingID]?.saving"
                  />
                </div>
                <div v-else class="date-cell">
                  <span v-if="slotProps.data.saleStartDate" class="date-text">
                    {{ formatDate(slotProps.data.saleStartDate) }}
                  </span>
                  <span v-else class="no-date-text">Not set</span>
                  <div v-if="slotProps.data.operationType === 'Update' && slotProps.data.currentSaleStartDate !== slotProps.data.saleStartDate" class="change-indicator">
                    <small class="current-value">Current: {{ formatDate(slotProps.data.currentSaleStartDate) }}</small>
                  </div>
                </div>
              </template>
            </Column>
            
            <Column header="Validation" style="min-width: 150px">
              <template #body="slotProps">
                <div v-if="slotProps.data.validationErrors" class="validation-errors">
                  <Tag value="Error" severity="danger" />
                  <small class="error-message">{{ slotProps.data.validationErrors }}</small>
                </div>
                <div v-else class="validation-success">
                  <Tag value="Valid" severity="success" />
                </div>
              </template>
            </Column>
            
            <Column header="Actions" style="width: 120px" :exportable="false">
              <template #body="slotProps">
                <div class="action-buttons">
                  <template v-if="isImportItemEditing(slotProps.data.stagingID)">
                    <Button 
                      icon="pi pi-save" 
                      class="p-button-text p-button-sm action-btn"
                      @click="saveImportItem(slotProps.data.stagingID)"
                      title="Save Changes"
                      :loading="editingImportItems[slotProps.data.stagingID]?.saving"
                    />
                    <Button 
                      icon="pi pi-times" 
                      class="p-button-rounded p-button-text p-button-sm p-button-danger action-btn"
                      @click="cancelImportEdit(slotProps.data.stagingID)"
                      title="Cancel Edit"
                      :disabled="editingImportItems[slotProps.data.stagingID]?.saving"
                    />
                  </template>
                  <template v-else>
                    <Button 
                      icon="pi pi-pencil" 
                      class="p-button-rounded p-button-text p-button-sm action-btn" 
                      @click="startImportEdit(slotProps.data)"
                      title="Edit"
                    />
                    <Button 
                      icon="pi pi-trash" 
                      class="p-button-rounded p-button-text p-button-sm p-button-danger action-btn"
                      @click="deleteImportItem(slotProps.data.stagingID)"
                      title="Delete"
                    />
                  </template>
                </div>
              </template>
            </Column>
          </DataTable>
        </template>
      </Card>
    </div>
  </div>

  <!-- Products Table -->
  <Card v-if="currentView !== 'tree' && currentView !== 'import'" class="products-table-card">
    <template #title>
      <div class="table-header">
        <div class="table-info">
          <span class="table-title">Products</span>
          <Tag v-if="totalCount" :value="`${totalCount} items`" class="ml-2" />
          <Tag v-if="currentView === 'inline' && hasUnsavedChanges" 
               value="Unsaved Changes" 
               severity="warning" 
               class="ml-2" />
        </div>
        
        <div class="table-controls">
          <!-- Add Product Button (for Table and Inline views) -->
          <Button
            label="Add Product"
            icon="pi pi-plus"
            @click="addProduct"
            class="p-button-success p-button-sm"
          />
          
          <!-- Inline Edit Controls -->
          <div v-if="currentView === 'inline'" class="inline-edit-controls">
            <Button
              label="Save All"
              icon="pi pi-check"
              @click="saveAllChanges"
              class="p-button-success p-button-sm"
              :disabled="!hasUnsavedChanges"
              :loading="bulkSaving"
            />
            <Button
              label="Discard"
              icon="pi pi-times"
              @click="discardAllChanges"
              class="p-button-danger p-button-outlined p-button-sm"
              :disabled="!hasUnsavedChanges"
            />
          </div>
          
          <!-- Regular Controls -->
          <Dropdown
            v-model="filters.pageSize"
            :options="pageSizeOptions"
            @change="search"
            class="page-size-dropdown"
          />
          <Button
            icon="pi pi-refresh"
            @click="search"
            class="p-button-outlined p-button-sm"
            title="Refresh"
          />
          <Button
            icon="pi pi-download"
            @click="exportData"
            class="p-button-outlined p-button-sm"
            title="Export"
          />
        </div>
      </div>
    </template>
    
    <template #content>
      <DataTable
        :value="products"
        :lazy="true"
        :paginator="true"
        :rows="filters.pageSize"
        :totalRecords="totalCount"
        :first="(filters.pageNumber - 1) * filters.pageSize"
        :loading="loading"
        @page="onPage"
        responsiveLayout="scroll"
        :sortField="filters.sortField"
        :sortOrder="filters.sortOrder"
        @sort="onSort"
        stripedRows
        class="products-table"
        :globalFilterFields="['name', 'category', 'sku']"
        paginatorTemplate="FirstPageLink PrevPageLink PageLinks NextPageLink LastPageLink CurrentPageReport RowsPerPageDropdown"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} products"
        :rowClass="getRowClass"
      >
        <Column header="Images" style="width: 120px" :exportable="false">
          <template #body="slotProps">
            <div class="product-image-cell">
              <!-- Inline Edit Mode -->
              <div v-if="currentView === 'inline' && isProductEditing(slotProps.data.productID)" class="inline-image-edit">
                <div class="image-management-inline">
                  <!-- Existing Images -->
                  <div v-if="editingProducts[slotProps.data.productID]?.images?.length" class="existing-images">
                    <div 
                      v-for="(image, index) in editingProducts[slotProps.data.productID].images" 
                      :key="image.imageID"
                      class="image-item"
                    >
                      <img :src="image.imageUrl" :alt="`Image ${index + 1}`" class="mini-thumbnail" />
                      <div class="image-controls">
                        <Button 
                          icon="pi pi-arrow-up" 
                          class="p-button-text p-button-sm mini-btn"
                          @click="moveImageUp(slotProps.data.productID, index)"
                          :disabled="index === 0"
                          title="Move Up"
                        />
                        <Button 
                          icon="pi pi-arrow-down" 
                          class="p-button-text p-button-sm mini-btn"
                          @click="moveImageDown(slotProps.data.productID, index)"
                          :disabled="index === editingProducts[slotProps.data.productID].images.length - 1"
                          title="Move Down"
                        />
                        <Button 
                          icon="pi pi-times" 
                          class="p-button-text p-button-sm p-button-danger mini-btn"
                          @click="removeImage(slotProps.data.productID, index)"
                          title="Remove"
                        />
                      </div>
                    </div>
                  </div>
                  
                  <!-- Add New Image Button -->
                  <div class="add-image-section">
                    <input 
                      type="file" 
                      accept="image/*" 
                      @change="addImageToProduct(slotProps.data.productID, $event)"
                      style="display: none"
                      :id="`fileInput-${slotProps.data.productID}`"
                    />
                    <Button 
                      icon="pi pi-plus" 
                      label="Add Image"
                      class="p-button-outlined p-button-sm"
                      @click="openFileDialog(slotProps.data.productID)"
                    />
                  </div>
                </div>
              </div>
              
              <!-- Regular View Mode -->
              <div v-else>
                <div 
                  v-if="slotProps.data.images?.length" 
                  @click="openGallery(slotProps.data)" 
                  class="image-thumbnail-container"
                >
                  <img
                    :src="slotProps.data.images[0].imageUrl"
                    :alt="slotProps.data.name"
                    class="image-thumbnail"
                  />
                  <div 
                    v-if="slotProps.data.images.length > 1" 
                    class="image-count-badge"
                  >
                    +{{ slotProps.data.images.length - 1 }}
                  </div>
                </div>
                <div v-else class="no-image-placeholder">
                  <i class="pi pi-image"></i>
                  <span>No image</span>
                </div>
              </div>
            </div>
          </template>
        </Column>

        <Column field="SKU" header="SKU" sortable style="min-width: 120px">
          <template #body="slotProps">
            <span class="sku-text">{{ slotProps.data.sku }}</span>
          </template>
        </Column>

        <Column field="Name" header="Name" sortable style="min-width: 200px">
          <template #body="slotProps">
            <div v-if="currentView === 'inline' && isProductEditing(slotProps.data.productID)" class="inline-edit-cell">
              <div class="name-input-container">
                <InputText
                  v-model="editingProducts[slotProps.data.productID].name"
                  placeholder="Product name"
                  class="inline-input"
                  @input="hasUnsavedChanges = true"
                  :disabled="editingProducts[slotProps.data.productID]?.saving"
                />
                <div v-if="editingProducts[slotProps.data.productID]?.saving" class="saving-indicator">
                  <i class="pi pi-spin pi-spinner"></i>
                  <small>Saving...</small>
                </div>
              </div>
              <Textarea
                v-model="editingProducts[slotProps.data.productID].description"
                placeholder="Description"
                :rows="2"
                class="inline-input mt-1"
                @input="hasUnsavedChanges = true"
                :disabled="editingProducts[slotProps.data.productID]?.saving"
              />
            </div>
            <div v-else class="product-name-cell">
              <span class="product-name">{{ slotProps.data.name }}</span>
              <small v-if="slotProps.data.description" class="product-description">
                {{ slotProps.data.description }}
              </small>
            </div>
          </template>
        </Column>

        <Column field="Category" header="Category" sortable style="min-width: 120px">
          <template #body="slotProps">
            <div v-if="currentView === 'inline' && isProductEditing(slotProps.data.productID)" class="inline-edit-cell">
              <Dropdown
                v-model="editingProducts[slotProps.data.productID].category"
                :options="categoryOptions"
                placeholder="Select category"
                class="inline-input"
                showClear
                editable
                @change="hasUnsavedChanges = true"
                :disabled="editingProducts[slotProps.data.productID]?.saving"
              />
            </div>
            <div v-else>
              <Tag :value="slotProps.data.category" class="category-tag" />
            </div>
          </template>
        </Column>

        <Column field="Price" header="Price" sortable style="min-width: 100px">
          <template #body="slotProps">
            <div v-if="currentView === 'inline' && isProductEditing(slotProps.data.productID)" class="inline-edit-cell">
              <InputNumber
                v-model="editingProducts[slotProps.data.productID].price"
                :min="0"
                :maxFractionDigits="2"
                mode="currency"
                currency="USD"
                class="inline-input"
                @input="hasUnsavedChanges = true"
                :disabled="editingProducts[slotProps.data.productID]?.saving"
              />
            </div>
            <div v-else>
              <span class="price-text">${{ Number(slotProps.data.price).toFixed(2) }}</span>
            </div>
          </template>
        </Column>

        <Column field="Stock" header="Stock" sortable style="min-width: 100px">
          <template #body="slotProps">
            <div v-if="currentView === 'inline' && isProductEditing(slotProps.data.productID)" class="inline-edit-cell">
              <InputNumber
                v-model="editingProducts[slotProps.data.productID].quantityInStock"
                :min="0"
                class="inline-input"
                @input="hasUnsavedChanges = true"
                :disabled="editingProducts[slotProps.data.productID]?.saving"
              />
            </div>
            <div v-else class="stock-cell">
              <Tag 
                :value="slotProps.data.quantityInStock" 
                :severity="getStockSeverity(slotProps.data.quantityInStock)"
                class="stock-badge"
              />
              <small class="stock-status">{{ getStockStatus(slotProps.data.quantityInStock) }}</small>
            </div>
          </template>
        </Column>

        <Column field="SaleStartDate" header="Sale Start Date" sortable style="min-width: 120px">
          <template #body="slotProps">
            <div v-if="currentView === 'inline' && isProductEditing(slotProps.data.productID)" class="inline-edit-cell">
              <Calendar
                v-model="editingProducts[slotProps.data.productID].saleStartDate"
                placeholder="Select date"
                dateFormat="mm/dd/yy"
                showIcon
                class="inline-input"
                @date-select="hasUnsavedChanges = true"
                @clear-click="hasUnsavedChanges = true"
                :disabled="editingProducts[slotProps.data.productID]?.saving"
              />
            </div>
            <div v-else class="date-cell">
              <span v-if="slotProps.data.saleStartDate" class="date-text">
                {{ formatDate(slotProps.data.saleStartDate) }}
              </span>
              <span v-else class="no-date-text">Not set</span>
            </div>
          </template>
        </Column>

        <Column header="Actions" style="width: 160px" :exportable="false">
          <template #body="slotProps">
            <div class="action-buttons">
              <!-- Inline Edit Mode Actions -->
              <template v-if="currentView === 'inline'">
                <template v-if="isProductEditing(slotProps.data.productID)">
                  <Button 
                    icon="pi pi-save" 
                    class="p-button-text p-button-sm action-btn"
                    @click="saveIndividualProduct(slotProps.data.productID)"
                    title="Save Product"
                    :loading="editingProducts[slotProps.data.productID]?.saving"
                  />
                  <Button 
                    icon="pi pi-times" 
                    class="p-button-rounded p-button-text p-button-sm p-button-danger action-btn"
                    @click="cancelInlineEdit(slotProps.data.productID)"
                    title="Cancel Edit"
                    :disabled="editingProducts[slotProps.data.productID]?.saving"
                  />
                </template>
                <template v-else>
                  <Button 
                    icon="pi pi-pencil" 
                    class="p-button-rounded p-button-text p-button-sm action-btn" 
                    @click="startInlineEdit(slotProps.data)"
                    title="Edit Inline"
                  />
                  <Button 
                    icon="pi pi-trash" 
                    class="p-button-rounded p-button-text p-button-sm p-button-danger action-btn" 
                    @click="confirmDelete(slotProps.data)"
                    title="Delete"
                  />
                </template>
              </template>
              
              <!-- Regular Table Mode Actions -->
              <template v-else>
                <Button 
                  icon="pi pi-eye" 
                  class="p-button-rounded p-button-text p-button-sm action-btn"
                  @click="viewProduct(slotProps.data)"
                  title="View"
                />
                <Button 
                  icon="pi pi-pencil" 
                  class="p-button-rounded p-button-text p-button-sm action-btn" 
                  @click="editProduct(slotProps.data)"
                  title="Edit"
                />
                <Button 
                  icon="pi pi-trash" 
                  class="p-button-rounded p-button-text p-button-sm p-button-danger action-btn" 
                  @click="confirmDelete(slotProps.data)"
                  title="Delete"
                />
              </template>
            </div>
          </template>
        </Column>
      </DataTable>
    </template>
  </Card>

  <!-- Image Gallery Dialog -->
  <Dialog
    v-model:visible="showGalleryDialog"
    modal
    header="Product Image Gallery"
    :style="{ width: '90vw' }"
    :breakpoints="{ '960px': '95vw', '640px': '100vw' }"
    class="image-gallery-dialog"
  >
    <template #header>
      <div class="gallery-header">
        <i class="pi pi-images mr-2"></i>
        <span>{{ galleryTitle }}</span>
      </div>
    </template>
    
    <Galleria
      :value="galleryImages"
      :numVisible="5"
      :showThumbnails="true"
      :showIndicators="true"
      :circular="true"
      :autoPlay="false"
      containerStyle="max-width: 100%"
      class="product-gallery"
    >
      <template #item="slotProps">
        <img
          :src="slotProps.item.imageUrl"
          :alt="'Image ' + slotProps.item.imageID"
          style="width: 100%; max-height: 70vh; object-fit: contain"
        />
      </template>
      <template #thumbnail="slotProps">
        <img
          :src="slotProps.item.imageUrl"
          style="width: 60px; height: 40px; object-fit: cover; border-radius: 4px"
        />
      </template>
    </Galleria>
  </Dialog>

  <!-- Add/Edit Product Dialog -->
  <Dialog
    v-model:visible="showFormDialog"
    modal
    :header="isEditMode ? 'Edit Product' : 'Add New Product'"
    :style="{ width: '700px', maxHeight: '90vh' }"
    :breakpoints="{ '960px': '90vw', '640px': '100vw' }"
    class="product-form-dialog"
  >
    <template #header>
      <div class="dialog-header">
        <i :class="isEditMode ? 'pi pi-pencil' : 'pi pi-plus'" class="mr-2"></i>
        <span>{{ isEditMode ? 'Edit Product' : 'Add New Product' }}</span>
      </div>
    </template>
    
    <TabView class="product-form-tabs">
      <TabPanel>
        <template #header>
          <i class="pi pi-info-circle mr-2"></i>
          <span>Product Information</span>
        </template>
        
        <div class="product-form">
          <div class="form-row">
            <div class="form-group">
              <label for="sku" class="form-label">SKU *</label>
              <InputText
                id="sku"
                v-model="productForm.sku"
                :disabled="isEditMode"
                placeholder="Auto-generated SKU"
                class="form-input"
              />
              <small v-if="skuError" class="error-message">
                <i class="pi pi-exclamation-triangle mr-1"></i>
                This SKU already exists
              </small>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="name" class="form-label">Product Name *</label>
              <InputText
                id="name"
                v-model="productForm.name"
                placeholder="Enter product name"
                class="form-input"
              />
            </div>
            
            <div class="form-group">
              <label for="category" class="form-label">Category *</label>
              <Dropdown
                id="category"
                v-model="productForm.category"
                :options="categoryOptions"
                placeholder="Select category"
                showClear
                editable
                class="form-input"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="price" class="form-label">Price *</label>
              <InputNumber
                id="price"
                v-model="productForm.price"
                :min="0"
                :maxFractionDigits="2"
                placeholder="0.00"
                mode="currency"
                currency="USD"
                class="form-input"
              />
            </div>
            
            <div class="form-group">
              <label for="stock" class="form-label">Stock Quantity *</label>
              <InputNumber
                id="stock"
                v-model="productForm.quantityInStock"
                :min="0"
                placeholder="0"
                class="form-input"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="saleStartDate" class="form-label">Sale Start Date</label>
              <Calendar
                id="saleStartDate"
                v-model="productForm.saleStartDate"
                placeholder="Select sale start date"
                dateFormat="mm/dd/yy"
                showIcon
                class="form-input"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group full-width">
              <label for="description" class="form-label">Description</label>
              <Textarea
                id="description"
                v-model="productForm.description"
                placeholder="Enter product description..."
                :rows="3"
                class="form-input"
              />
            </div>
          </div>
        </div>
      </TabPanel>

      <TabPanel>
        <template #header>
          <i class="pi pi-images mr-2"></i>
          <span>Product Images</span>
        </template>
        
        <div class="image-management">
          <ProductImageManager
            v-if="isEditMode"
            :productId="productForm.productID"
          />
          <ImageUploader
            v-else
            @update="imageFiles = $event"
          />
        </div>
      </TabPanel>
    </TabView>

    <template #footer>
      <div class="dialog-footer">
        <Button
          label="Cancel"
          icon="pi pi-times"
          @click="showFormDialog = false"
          class="p-button-text"
        />
        <Button
          :label="isEditMode ? 'Update Product' : 'Add Product'"
          icon="pi pi-check"
          @click="saveProduct"
          class="p-button-primary"
          :loading="saving"
        />
      </div>
    </template>
  </Dialog>
</div>

