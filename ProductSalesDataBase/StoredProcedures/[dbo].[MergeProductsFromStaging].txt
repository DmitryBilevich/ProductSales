SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[MergeProductsFromStaging]
AS
BEGIN
    SET NOCOUNT ON;

    MERGE Products AS Target
    USING (
        SELECT
            s.ProductCode,
            s.Name,
            s.Category,
            s.Price,
            s.QuantityInStock,
            s.Description
        FROM ProductImportStaging s
    ) AS Source
    ON Target.Name = Source.Name

    WHEN MATCHED THEN
        UPDATE SET
            Target.Category = Source.Category,
            Target.Price = Source.Price,
            Target.QuantityInStock = Source.QuantityInStock,
            Target.Description = Source.Description

    WHEN NOT MATCHED BY TARGET THEN
        INSERT (Name, Category, Price, QuantityInStock, Description)
        VALUES (Source.Name, Source.Category, Source.Price, Source.QuantityInStock, Source.Description);
    
    -- Clrear staging table 
    DELETE FROM ProductImportStaging;
END;
GO
