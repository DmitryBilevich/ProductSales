SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Stored Procedure: CheckOrReserveSKUJson
-- Description: Check or reserve SKU with JSON input and JSON output
-- =============================================

CREATE   PROCEDURE [dbo].[CheckOrReserveSKUJson]
    @JsonInput NVARCHAR(MAX)
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Parse JSON input parameters
    DECLARE @SKU NVARCHAR(100) = JSON_VALUE(@JsonInput, '$.sku')
    DECLARE @Reserve BIT = TRY_CAST(JSON_VALUE(@JsonInput, '$.reserve') AS BIT)
    DECLARE @ReservedBy NVARCHAR(255) = JSON_VALUE(@JsonInput, '$.reservedBy')
    
    -- Validate input
    IF @SKU IS NULL OR @SKU = ''
    BEGIN
        SELECT (
            SELECT 
                0 as success,
                'SKU is required' as message,
                0 as available,
                NULL as sku
            FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
        ) as JsonResult
        RETURN
    END
    
    -- Check if SKU exists
    DECLARE @Exists BIT = 0
    IF EXISTS(SELECT 1 FROM Products WHERE SKU = @SKU)
        SET @Exists = 1
    
    -- If reserving and SKU is available
    IF @Reserve = 1 AND @Exists = 0
    BEGIN
        -- For now, just return success (no actual reservation table in schema)
        -- In a full implementation, you'd insert into a SKUReservations table
        SELECT (
            SELECT 
                1 as success,
                'SKU reserved successfully' as message,
                1 as available,
                @SKU as sku,
                1 as reserved,
                @ReservedBy as reservedBy
            FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
        ) as JsonResult
    END
    ELSE
    BEGIN
        -- Just check availability
        SELECT (
            SELECT 
                1 as success,
                CASE 
                    WHEN @Exists = 1 THEN 'SKU already exists'
                    ELSE 'SKU is available'
                END as message,
                CASE WHEN @Exists = 1 THEN 0 ELSE 1 END as available,
                @SKU as sku,
                0 as reserved,
                NULL as reservedBy
            FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
        ) as JsonResult
    END
END
GO
