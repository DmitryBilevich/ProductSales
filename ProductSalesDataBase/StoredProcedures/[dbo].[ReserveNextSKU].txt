SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ReserveNextSKU]
    @ReservedBy NVARCHAR(100) = NULL
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Base NVARCHAR(20) = FORMAT(GETDATE(), 'yyyyMMdd');
    DECLARE @Suffix INT = 1;
    DECLARE @CandidateSKU NVARCHAR(50);
    DECLARE @Exists INT = 1;

    WHILE @Exists = 1
    BEGIN
        SET @CandidateSKU = CONCAT('SKU-', @Base, '-', RIGHT('000' + CAST(@Suffix AS VARCHAR), 4));

        IF NOT EXISTS (
            SELECT 1 FROM Products WHERE SKU = @CandidateSKU
            UNION
            SELECT 1 FROM ReservedSKUs WHERE SKU = @CandidateSKU
        )
        BEGIN
            SET @Exists = 0;
        END
        ELSE
        BEGIN
            SET @Suffix = @Suffix + 1;
        END
    END

    INSERT INTO ReservedSKUs (SKU, ReservedBy)
    VALUES (@CandidateSKU, @ReservedBy);

    SELECT @CandidateSKU AS ReservedSKU;
END
GO
