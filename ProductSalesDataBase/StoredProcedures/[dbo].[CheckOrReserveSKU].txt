SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[CheckOrReserveSKU]
    @SKU NVARCHAR(50),
    @Reserve BIT = 0,
    @ReservedBy NVARCHAR(100) = NULL
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @IsTakenInProducts BIT = 0;
    DECLARE @IsTakenInReserveByOthers BIT = 0;
    DECLARE @ProductID INT = NULL;

    -- Проверка в основной таблице
    SELECT TOP 1
        @IsTakenInProducts = 1,
        @ProductID = ProductID
    FROM Products
    WHERE SKU = @SKU;

    -- Проверка в резерве, но исключаем свои резервы
    SELECT TOP 1 @IsTakenInReserveByOthers = 1
    FROM ReservedSKUs
    WHERE SKU = @SKU AND (ReservedBy IS NULL OR ReservedBy <> @ReservedBy);

    -- Если занят или зарезервирован кем-то другим → занято
    IF (@IsTakenInProducts = 1 OR @IsTakenInReserveByOthers = 1)
    BEGIN
        SELECT
            1 AS IsTaken,
            @ProductID AS ProductID,
            0 AS Reserved;
        RETURN;
    END

    -- Если разрешено зарезервировать
    IF @Reserve = 1
    BEGIN
        -- Зарезервируем только если ещё не зарезервирован никем
        IF NOT EXISTS (
            SELECT 1 FROM ReservedSKUs WHERE SKU = @SKU
        )
        BEGIN
            INSERT INTO ReservedSKUs (SKU, ReservedBy)
            VALUES (@SKU, @ReservedBy);
        END

        SELECT
            0 AS IsTaken,
            NULL AS ProductID,
            1 AS Reserved;
        RETURN;
    END

    -- SKU свободен, но не зарезервирован
    SELECT
        0 AS IsTaken,
        NULL AS ProductID,
        0 AS Reserved;
END
GO
