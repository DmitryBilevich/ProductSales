SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[UpdateProductImportStaging]
    @StagingID INT,
    @SKU NVARCHAR(100) = NULL,
    @Name NVARCHAR(200),
    @Category NVARCHAR(100) = NULL,
    @Price DECIMAL(18,2),
    @QuantityInStock INT,
    @Description NVARCHAR(MAX) = NULL,
    @SaleStartDate DATETIME = NULL
AS
BEGIN
    SET NOCOUNT ON;
    
    DECLARE @ImportSessionID UNIQUEIDENTIFIER;
    DECLARE @ValidationErrors NVARCHAR(MAX) = NULL;
    DECLARE @ExistingProductID INT;
    
    -- Get current record info
    SELECT 
        @ImportSessionID = ImportSessionID,
        @ExistingProductID = ExistingProductID
    FROM ProductImportStaging 
    WHERE StagingID = @StagingID;
    
    -- Validate data
    IF @Name IS NULL OR @Name = ''
        SET @ValidationErrors = '"Name is required"';
    ELSE IF @Price IS NULL OR @Price < 0
        SET @ValidationErrors = '"Invalid price"';
    ELSE IF @QuantityInStock IS NULL OR @QuantityInStock < 0
        SET @ValidationErrors = '"Invalid stock quantity"';
    ELSE IF @SKU IS NOT NULL AND @SKU != '' AND EXISTS(
        SELECT 1 FROM Products p 
        WHERE p.SKU = @SKU AND (@ExistingProductID IS NULL OR p.ProductID != @ExistingProductID)
    )
        SET @ValidationErrors = '"SKU already exists for different product"';
    
    -- Update the staging record
    UPDATE ProductImportStaging SET
        SKU = @SKU,
        Name = @Name,
        Category = @Category,
        Price = @Price,
        QuantityInStock = @QuantityInStock,
        Description = @Description,
        SaleStartDate = @SaleStartDate,
        ValidationErrors = @ValidationErrors,
        ModifiedAt = GETUTCDATE()
    WHERE StagingID = @StagingID;
    
    IF @@ROWCOUNT > 0
        SELECT 1 as Success, 'Product updated successfully' as Message;
    ELSE
        SELECT 0 as Success, 'Product not found' as Message;
END
GO
