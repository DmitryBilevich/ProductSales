SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Stored Procedure: DeleteProductJson
-- Description: Delete product with JSON input and JSON output
-- =============================================

CREATE   PROCEDURE [dbo].[DeleteProductJson]
    @JsonInput NVARCHAR(MAX)
AS
BEGIN
    SET NOCOUNT ON;
    
    BEGIN TRY
        BEGIN TRANSACTION;
        
        -- Parse JSON input parameter
        DECLARE @ProductID INT = TRY_CAST(JSON_VALUE(@JsonInput, '$.productID') AS INT)
        
        -- Validate input
        IF @ProductID IS NULL OR @ProductID <= 0
        BEGIN
            SELECT (
                SELECT 
                    0 as success,
                    'Invalid product ID' as message
                FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
            ) as JsonResult
            RETURN
        END
        
        -- Check if product exists
        IF NOT EXISTS(SELECT 1 FROM Products WHERE ProductID = @ProductID)
        BEGIN
            SELECT (
                SELECT 
                    0 as success,
                    'Product not found' as message
                FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
            ) as JsonResult
            RETURN
        END
        
        -- Get product info before deletion (for response)
        DECLARE @ProductName NVARCHAR(255)
        DECLARE @ProductSKU NVARCHAR(100)
        SELECT @ProductName = Name, @ProductSKU = SKU 
        FROM Products 
        WHERE ProductID = @ProductID
        
        -- Delete related images first (cascade)
        DELETE FROM ProductImages WHERE ProductID = @ProductID
        
        -- Delete the product
        DELETE FROM Products WHERE ProductID = @ProductID
        
        COMMIT TRANSACTION;
        
        -- Return success response
        SELECT (
            SELECT 
                1 as success,
                'Product deleted successfully' as message,
                @ProductID as productID,
                @ProductName as productName,
                @ProductSKU as productSKU
            FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
        ) as JsonResult
        
    END TRY
    BEGIN CATCH
        IF @@TRANCOUNT > 0
            ROLLBACK TRANSACTION;
            
        -- Return error response
        SELECT (
            SELECT 
                0 as success,
                ERROR_MESSAGE() as message
            FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
        ) as JsonResult
    END CATCH
END
GO
