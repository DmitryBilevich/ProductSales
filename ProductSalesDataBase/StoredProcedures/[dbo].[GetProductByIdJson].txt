SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Stored Procedure: GetProductByIdJson
-- Description: Get single product by ID with JSON input and JSON output
-- =============================================

CREATE   PROCEDURE [dbo].[GetProductByIdJson]
    @JsonInput NVARCHAR(MAX)
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Parse JSON input parameter
    DECLARE @ProductID INT = TRY_CAST(JSON_VALUE(@JsonInput, '$.productID') AS INT)
    
    -- Validate input
    IF @ProductID IS NULL OR @ProductID <= 0
    BEGIN
        SELECT (
            SELECT 
                0 as success,
                'Invalid product ID' as message,
                NULL as product
            FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
        ) as JsonResult
        RETURN
    END
    
    -- Check if product exists and return product data
    IF EXISTS(SELECT 1 FROM Products WHERE ProductID = @ProductID)
    BEGIN
        SELECT (
            SELECT 
                1 as success,
                'Product found' as message,
                (
                    SELECT 
                        p.ProductID as productID,
                        p.SKU as sku,
                        p.Name as name,
                        p.Category as category,
                        p.Price as price,
                        p.QuantityInStock as quantityInStock,
                        p.Description as description,
                        p.SaleStartDate as saleStartDate,
                        p.CreatedAt as createdAt,
                        (
                            SELECT 
                                img.ImageID as imageID,
                                img.FileName as fileName,
                                img.ImageData as imageData,
                                img.ContentType as contentType,
                                img.ImageOrder as [order]
                            FROM ProductImages img
                            WHERE img.ProductID = p.ProductID
                            ORDER BY img.ImageOrder
                            FOR JSON PATH
                        ) as images
                    FROM Products p
                    WHERE p.ProductID = @ProductID
                    FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
                ) as product
            FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
        ) as JsonResult
    END
    ELSE
    BEGIN
        SELECT (
            SELECT 
                0 as success,
                'Product not found' as message,
                NULL as product
            FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
        ) as JsonResult
    END
END
GO
