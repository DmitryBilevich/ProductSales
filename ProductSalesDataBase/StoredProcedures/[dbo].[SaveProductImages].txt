SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SaveProductImages]
    @Images ProductImageTableType READONLY
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO ProductImages (ProductID, FileName, UploadedAt, ImageOrder)
    SELECT
        ISNULL(p.ProductID, i.ProductID),
        i.FileName,
        i.UploadedAt,
        i.ImageOrder
    FROM @Images i
    LEFT JOIN Products p ON i.SKU = p.SKU
    WHERE ISNULL(p.ProductID, p.ProductID) IS NOT NULL;
END
GO
